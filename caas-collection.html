<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../caas-crud-behavior/caas-crud-behavior.html">
<link rel="import" href="../caas-document/caas-document.html">

<!--
`caas-collection`


@demo demo/index.html 
-->

<dom-module id="caas-collection">
  <template>

      <iron-ajax
        id="readDocuments"
        headers="[[_requestHeaders]]"
        url="[[apiEndpoint]]/[[route]]"
        method="GET"
        last-response="{{documents}}"
        debounce-duration="[[debounceDuration]]"
        auto="[[autoRead]]"
        loading="{{reading}}"
        on-response="_handleReadResponse"
        on-error="_handleReadResponseError"
      ></iron-ajax>

      <template is="dom-repeat" items="{{documents}}" as="document">
        <caas-document
          api-endpoint="[[apiEndpoint]]"
          access-token="[[accessToken]]"
          auth="[[auth]]"
          route="[[route]]/[[document.id]]"
          debounce-duration="[[debounceDuration]]"
          document="{{document}}"
          auto-update="[[autoUpdate]]"
          on-updated="_handleDocumentUpdated"
          on-update-error="_handleDocumentUpdateError"
        ></caas-document>
      </template>

  </template>
  <script>
    Polymer({

      is: 'caas-collection',
      behaviors: [CaasCrudBehavior],

      properties: {

        /**
        * The documents array
        */
        documents: {
          type: Array,
          value: [],
          notify: true
        },

        hasChanges: {
          type: Boolean,
          computed: '_computeHasChanges(changedDocuments.splices)',
          observer: '_hasChangesChanged',
          notify: true
        },

        changedDocuments: {
          type: Array,
          value: [],
          notify: true
        },

        trackChanges: {
          type: Boolean,
          value: false
        },

        updateInterval: {
          type: Number,
          value: 3000
        },

        _shadowDocuments: {
          type: Array,
          value: []
        },

        _updateTimer: {
          type: Object
        },

      },

      observers: [
        '_resetUpdateInterval(trackChanges, autoUpdate, updateInterval)'
      ],

      read: function() {
        this._sendAjaxRequest('read');
      },

      update: function() {
        this._diffDocuments();
        for(var i=0;i<this.changedDocuments.length;i++) {
          this.updateItem(i);
        }
      },

      _handleDocumentUpdated: function(evt) {
        var documentId = evt.target.document.id;
        var changedDocumentsIds = this._getChangedDocumentIds();
        var existingIndex = changedDocumentsIds.indexOf(documentId);
        if(existingIndex !== -1) {
          this._removeChangedDocument(this.changedDocuments[existingIndex]);
        }
      },

      _handleDocumentUpdateError: function(evt) {
        //console.log('_handleDocumentUpdateError', evt.target.document);
      },

      updateItem: function(i) {
        var documentIndex = this.changedDocuments[i].index;
        var caasDoc = this.querySelectorAll('caas-document')[documentIndex];
        caasDoc.notifyProperties();
        caasDoc.update();
      },

      _computeHasChanges: function(changedDocumentsSplices) {
        return (this.changedDocuments.length > 0);
      },

      _hasChangesChanged: function(hasChanges) {
        if(hasChanges && this.autoUpdate) {
          this.update();
        }
      },

      _diffDocuments: function() {
        if(!this._shadowDocuments || this._shadowDocuments.length === 0) {
          this.set('_shadowDocuments', []);
          for(var i=0;i<this.documents.length;i++) {
            this._shadowDocuments.push(JSON.stringify(this.documents[i]));
          }
        } else {
          for(var i=0;i<this.documents.length;i++) {
            this._diffItem(i);
          }          
        }
      },

      _diffItem: function(i) {
        var masterDocument = JSON.stringify(this.documents[i]);
        var shadowDocument = this._shadowDocuments[i];
        var documentId = this.documents[i].id;

        if(masterDocument !== shadowDocument) {
          this._addChangedDocument(documentId, i);
          this._shadowDocuments[i] = masterDocument;
        }
      },

      _addChangedDocument: function(documentId, i) {
        var changedDocumentsIds = this._getChangedDocumentIds();
        var existingIndex = changedDocumentsIds.indexOf(documentId);
        if(existingIndex === -1) {
          this.push('changedDocuments', {
            index: i,
            id: documentId
          });
        }
      },

      _removeChangedDocument: function(changedDocument) {
        var changedDocumentsIds = this._getChangedDocumentIds();
        var existingIndex = changedDocumentsIds.indexOf(changedDocument.id);
        this.splice('changedDocuments', existingIndex, 1);
      },

      _getChangedDocumentIds: function(documentId) {
        return this.changedDocuments.map(function(changedDocument) {
          return changedDocument.id;
        })
      },

      _resetUpdateInterval: function(trackChanges, autoUpdate, updateInterval) {
        window.clearInterval(this._updateTimer);
        this._diffDocuments();            
        if(!trackChanges) return;
        this._updateTimer = window.setInterval((function() {
          if(autoUpdate) {
            this.update();
          } else {
            this._diffDocuments();            
          }
        }).bind(this), updateInterval);
      }

    });
  </script>
</dom-module>